// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// USUARIO/AGENTE: Información del agente inmobiliario
model Usuario {
  id                String    @id @default(cuid())
  nombre            String    @unique
  email             String?   @unique
  telefono          String?
  avatar            String?   // URL del avatar
  activo            Boolean   @default(true)
  
  // Autenticación
  password          String?   // Hash de la contraseña
  rol               String    @default("agente") // "admin" | "agente" | "supervisor"
  
  // Sesión
  lastLogin         DateTime?
  
  // Relaciones
  propiedades       Propiedad[]
  clientes          Cliente[]
  operaciones       Operacion[]
  sesiones          Session[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// SESSION: Sesiones activas de usuarios
model Session {
  id                String    @id @default(cuid())
  usuarioId         String
  usuario           Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  token             String    @unique
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  
  @@index([token])
  @@index([usuarioId])
}

// CLIENTE: Datos del cliente/comprador
model Cliente {
  id                String    @id @default(cuid())
  nombreCompleto    String
  telefono          String?
  email             String?
  notas             String?
  
  // Relación con agente
  usuarioId         String?
  usuario           Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  // Relaciones
  busquedas         Busqueda[]
  tareas            Tarea[]
  operaciones       Operacion[]
  enviosPropiedades EnvioPropiedad[]
  comunicaciones    Comunicacion[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([nombreCompleto, usuarioId])
}

// BUSQUEDA: Lead comprador / Búsqueda activa de cliente
model Busqueda {
  id                    String    @id @default(cuid())
  clienteId             String
  cliente               Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  // Origen de la búsqueda
  origen                String    // ENUM: ACTIVA | PERSONALIZADA | CALIFICADA_EFECTIVO | CALIFICADA_CREDITO
  
  // Presupuesto
  presupuestoTexto      String?   // Original: "75 MIL DOLARES", "2.500.000", etc
  presupuestoValor      Int?      // Numérico si se pudo extraer
  moneda                String?   // ARS | USD
  
  // Preferencias de propiedad
  tipoPropiedad         String?   // DEPARTAMENTO | CASA | OTRO
  ubicacionPreferida    String?
  dormitoriosMin        Int?
  cochera               String?   // SI | NO | descripción
  
  // Fin de uso
  finalidad             String?   // INVERSION | VIVIENDA
  
  // Estado del pipeline
  estado                String    @default("NUEVO") // NUEVO | CALIFICADO | VISITA | RESERVA | CERRADO | PERDIDO
  
  // Notas y referencias
  observaciones         String?
  planillaRef           String?   // Referencia a la planilla original
  
  // Relaciones
  matchesPropiedades    MatchBusquedaPropiedad[]
  tareas                Tarea[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// PROPIEDAD: Inventario/oportunidades inmobiliarias
model Propiedad {
  id                String    @id @default(cuid())
  
  // Ubicación y descripción
  titulo            String?   // Título de la propiedad
  tipo              String    // CASA | DEPARTAMENTO | TERRENO | SOLAR | OTRO
  subtipo           String?   // Tipo original del Excel
  ubicacion         String
  zona              String?   // Zona/barrio
  localidad         String?
  direccion         String?
  
  // Características
  precio            Int?      // Precio numérico
  moneda            String    @default("USD") // ARS | USD
  descripcion       String?
  dormitorios       Int?
  ambientes         Int?      // Número total de ambientes
  banos             Int?      // Número de baños
  superficie        Int?      // Superficie en m²
  whatsapp          String?   // Contacto WhatsApp
  
  // Enlaces y fuentes
  urlMls            String?   // URL a MLS/Inmobiliaria
  fuente            String?   // APTA_CREDITO | OTRA
  aptaCredito       Boolean   @default(false)
  
  // Relación con agente
  usuarioId         String?
  usuario           Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  // Relaciones
  matches           MatchBusquedaPropiedad[]
  envios            EnvioPropiedad[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([direccion, tipo, usuarioId])
  @@index([localidad])
  @@index([aptaCredito])
  @@index([zona])
  @@index([usuarioId])
}

// MATCH: Relación entre búsqueda y propiedad sugerida
model MatchBusquedaPropiedad {
  id                String    @id @default(cuid())
  busquedaId        String
  busqueda          Busqueda  @relation(fields: [busquedaId], references: [id], onDelete: Cascade)
  
  propiedadId       String
  propiedad         Propiedad @relation(fields: [propiedadId], references: [id], onDelete: Cascade)
  
  estado            String    @default("SUGERIDA") // SUGERIDA | ENVIADA | VISITA | DESCARTADA | RESERVADA
  notas             String?
  
  fecha             DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([busquedaId, propiedadId])
}

// TAREA: Agenda/To-do items
model Tarea {
  id                String    @id @default(cuid())
  
  // Asignación
  clienteId         String?
  cliente           Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  
  busquedaId        String?
  busqueda          Busqueda? @relation(fields: [busquedaId], references: [id], onDelete: SetNull)
  
  // Contenido
  titulo            String
  descripcion       String?
  fechaVencimiento  DateTime?
  estado            String    @default("PENDIENTE") // PENDIENTE | HECHA
  prioridad         String    @default("MEDIA") // BAJA | MEDIA | ALTA
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([clienteId])
  @@index([busquedaId])
  @@index([estado])
}

// OPERACION: Cierre de venta y comisiones
model Operacion {
  id                        String    @id @default(cuid())
  
  nro                       Int?      @unique
  clienteId                 String?
  cliente                   Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  
  // Relación con agente
  usuarioId                 String?
  usuario                   Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  // Descripción de la operación
  descripcion               String
  precioReal                Int?      // Precio de venta
  
  // Comisiones (6% total según estructura REMAX)
  comisionTotal             Float?    // 6% total
  totalComisionEquipo       Float?    // 45% del total (de la comisión)
  comisionEquipoUnaPunta    Float?    // 50% de equipo (una punta)
  comisionLeoDosPuntas      Float?    // 20% por dos puntas
  comisionLeoUnaPunta       Float?    // 20% por una punta
  
  // Cronograma
  fechaPagoAprox            DateTime?
  observaciones             String?
  
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  
  @@index([nro])
  @@index([usuarioId])
}

// RESERVA Y DOCUMENTACION
model ReservaDocumento {
  id                    String    @id @default(cuid())
  
  nro                   Int?      @unique
  reservaTexto          String?
  boletoCompraVentaTexto String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// CONFIGURACION: Rutas y datos de importación
model ConfigImport {
  id                String    @id @default(cuid())
  
  clave             String    @unique // nombre de la configuración
  valor             String    // ruta o valor
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ENVIO DE PROPIEDAD: Registro de links enviados a clientes
model EnvioPropiedad {
  id                String    @id @default(cuid())
  
  clienteId         String
  cliente           Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  propiedadId       String?
  propiedad         Propiedad? @relation(fields: [propiedadId], references: [id], onDelete: SetNull)
  
  // Si no es una propiedad del sistema, guardar URL externa
  urlExterna        String?   // Link externo (MLS, Argenprop, etc)
  tituloExterno     String?   // Descripción del link externo
  
  // Detalles del envío
  canal             String    @default("WHATSAPP") // WHATSAPP | EMAIL | OTRO
  mensaje           String?   // Mensaje enviado (opcional)
  respuesta         String?   // INTERESADO | NO_INTERESADO | SIN_RESPUESTA | VISITA_PROGRAMADA
  
  fechaEnvio        DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([clienteId])
  @@index([propiedadId])
  @@index([fechaEnvio])
}

// COMUNICACION: Log de conversaciones WhatsApp/Email
model Comunicacion {
  id                String    @id @default(cuid())
  
  clienteId         String
  cliente           Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  // Tipo de comunicación
  tipo              String    @default("WHATSAPP") // WHATSAPP | LLAMADA | EMAIL | VISITA | OTRO
  direccion         String    @default("SALIENTE") // SALIENTE | ENTRANTE
  
  // Contenido
  resumen           String    // Resumen de la conversación
  detalle           String?   // Detalles adicionales
  
  // Resultado
  resultado         String?   // CONTACTADO | NO_CONTESTO | OCUPADO | CITA_AGENDADA | etc
  
  // Seguimiento
  requiereSeguimiento Boolean @default(false)
  fechaSeguimiento  DateTime?
  
  fecha             DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([clienteId])
  @@index([fecha])
  @@index([tipo])
}
