// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// INMOBILIARIA: Entidad principal que agrupa usuarios, clientes y propiedades
model Inmobiliaria {
  id                String    @id @default(cuid())
  nombre            String    @unique
  slug              String    @unique // URL-friendly: "carli-esquivel", "solar"
  logo              String?   // URL del logo
  whatsapp          String?   // WhatsApp principal
  email             String?   // Email de contacto
  direccion         String?   // Dirección física
  activa            Boolean   @default(true)
  
  // Configuración visual
  colorPrimario     String?   // Color de marca (hex)
  
  // Configuración de comisiones
  // Solar: comisionVenta=3%, comisionAgente=50% (agente recibe 50% del 3%)
  // RE/MAX: comisionVenta=6%, comisionAgente=20% (agente recibe 20% del 6%)
  comisionVenta     Float     @default(3)    // % sobre precio de venta
  comisionAgente    Float     @default(50)   // % que recibe el agente de la comisión
  
  // Relaciones
  usuarios          Usuario[]
  clientes          Cliente[]
  propiedades       Propiedad[]
  operaciones       Operacion[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// USUARIO/AGENTE: Información del agente inmobiliario
model Usuario {
  id                String    @id @default(cuid())
  nombre            String
  email             String?   @unique
  telefono          String?
  avatar            String?   // URL del avatar
  activo            Boolean   @default(true)
  
  // Autenticación
  password          String?   // Hash de la contraseña
  rol               String    @default("agente") // "superadmin" | "admin" | "agente" | "supervisor"
  
  // Sesión
  lastLogin         DateTime?
  
  // Relación con inmobiliaria (obligatoria excepto superadmin)
  inmobiliariaId    String?
  inmobiliaria      Inmobiliaria? @relation(fields: [inmobiliariaId], references: [id], onDelete: SetNull)
  
  // Relaciones
  propiedades       Propiedad[]
  clientes          Cliente[]
  operaciones       Operacion[]
  sesiones          Session[]
  busquedasCreadas  Busqueda[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([nombre, inmobiliariaId])
  @@index([inmobiliariaId])
}

// SESSION: Sesiones activas de usuarios
model Session {
  id                String    @id @default(cuid())
  usuarioId         String
  usuario           Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  token             String    @unique
  expiresAt         DateTime
  createdAt         DateTime  @default(now())
  
  @@index([token])
  @@index([usuarioId])
}

// CLIENTE: Datos del cliente/comprador
model Cliente {
  id                String    @id @default(cuid())
  nombreCompleto    String
  telefono          String?
  email             String?
  notas             String?
  
  // Relación con inmobiliaria
  inmobiliariaId    String?
  inmobiliaria      Inmobiliaria? @relation(fields: [inmobiliariaId], references: [id], onDelete: SetNull)
  
  // Relación con agente
  usuarioId         String?
  usuario           Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  // Relaciones
  busquedas         Busqueda[]
  tareas            Tarea[]
  operaciones       Operacion[]
  enviosPropiedades EnvioPropiedad[]
  comunicaciones    Comunicacion[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([nombreCompleto, inmobiliariaId])
  @@index([inmobiliariaId])
}

// BUSQUEDA: Lead comprador / Búsqueda activa de cliente
model Busqueda {
  id                    String    @id @default(cuid())
  clienteId             String
  cliente               Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  // Origen de la búsqueda
  origen                String    // ENUM: ACTIVA | PERSONALIZADA | CALIFICADA_EFECTIVO | CALIFICADA_CREDITO
  
  // Presupuesto
  presupuestoTexto      String?   // Original: "75 MIL DOLARES", "2.500.000", etc
  presupuestoValor      Int?      // Numérico si se pudo extraer
  moneda                String?   // ARS | USD
  
  // Preferencias de propiedad
  tipoPropiedad         String?   // DEPARTAMENTO | CASA | OTRO
  ubicacionPreferida    String?
  dormitoriosMin        Int?
  cochera               String?   // SI | NO | descripción
  
  // Fin de uso
  finalidad             String?   // INVERSION | VIVIENDA
  
  // Estado del pipeline
  estado                String    @default("NUEVO") // NUEVO | CALIFICADO | VISITA | RESERVA | CERRADO | PERDIDO
  
  // Notas y referencias
  observaciones         String?
  planillaRef           String?   // Referencia a la planilla original
  
  // Agente que creó la búsqueda
  createdBy             String?
  usuario               Usuario?  @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  
  // Relaciones
  matchesPropiedades    MatchBusquedaPropiedad[]
  tareas                Tarea[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([createdBy])
}

// PROPIEDAD: Inventario/oportunidades inmobiliarias
model Propiedad {
  id                String    @id @default(cuid())
  
  // Ubicación y descripción
  titulo            String?   // Título de la propiedad
  tipo              String    // CASA | DEPARTAMENTO | TERRENO | SOLAR | OTRO
  subtipo           String?   // Tipo original del Excel
  ubicacion         String
  zona              String?   // Zona/barrio
  localidad         String?
  direccion         String?
  
  // Características
  precio            Int?      // Precio numérico
  moneda            String    @default("USD") // ARS | USD
  descripcion       String?
  dormitorios       Int?
  ambientes         Int?      // Número total de ambientes
  banos             Int?      // Número de baños
  superficie        Int?      // Superficie en m²
  superficieCubierta Int?     // Superficie cubierta en m²
  cochera           Boolean   @default(false)
  patio             Boolean   @default(false)
  pileta            Boolean   @default(false)
  whatsapp          String?   // Contacto WhatsApp
  
  // Imágenes
  imagenPrincipal   String?   // URL de la imagen principal
  imagenes          String[]  // Array de URLs de imágenes adicionales
  
  // Enlaces y fuentes
  urlMls            String?   // URL a MLS/Inmobiliaria
  fuente            String?   // APTA_CREDITO | OTRA
  aptaCredito       Boolean   @default(false)
  
  // Relación con inmobiliaria
  inmobiliariaId    String?
  inmobiliaria      Inmobiliaria? @relation(fields: [inmobiliariaId], references: [id], onDelete: SetNull)
  
  // Relación con agente
  usuarioId         String?
  usuario           Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  // Estado de la propiedad
  estado            String    @default("BORRADOR") // BORRADOR | EN_ANALISIS | APROBADA | DESCARTADA
  
  // Relaciones
  matches           MatchBusquedaPropiedad[]
  envios            EnvioPropiedad[]
  tareas            Tarea[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([direccion, tipo, inmobiliariaId])
  @@index([localidad])
  @@index([aptaCredito])
  @@index([zona])
  @@index([usuarioId])
  @@index([inmobiliariaId])
  @@index([estado])
}

// MATCH: Relación entre búsqueda y propiedad sugerida
model MatchBusquedaPropiedad {
  id                String    @id @default(cuid())
  busquedaId        String
  busqueda          Busqueda  @relation(fields: [busquedaId], references: [id], onDelete: Cascade)
  
  propiedadId       String
  propiedad         Propiedad @relation(fields: [propiedadId], references: [id], onDelete: Cascade)
  
  estado            String    @default("SUGERIDA") // SUGERIDA | ENVIADA | VISITA | DESCARTADA | RESERVADA
  notas             String?
  
  fecha             DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([busquedaId, propiedadId])
}

// TAREA: Agenda/To-do items
model Tarea {
  id                String    @id @default(cuid())
  
  // Asignación
  clienteId         String?
  cliente           Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  
  busquedaId        String?
  busqueda          Busqueda? @relation(fields: [busquedaId], references: [id], onDelete: SetNull)

  propiedadId       String?
  propiedad         Propiedad? @relation(fields: [propiedadId], references: [id], onDelete: SetNull)
  
  // Contenido
  titulo            String
  descripcion       String?
  fechaVencimiento  DateTime?
  estado            String    @default("PENDIENTE") // PENDIENTE | HECHA
  prioridad         String    @default("MEDIA") // BAJA | MEDIA | ALTA
  tipo              String    @default("GENERAL") // GENERAL | VISITA | LLAMADA
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([clienteId])
  @@index([busquedaId])
  @@index([propiedadId])
  @@index([estado])
}

// OPERACION: Cierre de venta y comisiones
model Operacion {
  id                        String    @id @default(cuid())
  
  nro                       Int?      @unique
  clienteId                 String?
  cliente                   Cliente?  @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  
  // Relación con inmobiliaria
  inmobiliariaId            String?
  inmobiliaria              Inmobiliaria? @relation(fields: [inmobiliariaId], references: [id], onDelete: SetNull)
  
  // Relación con agente
  usuarioId                 String?
  usuario                   Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  // Descripción de la operación
  descripcion               String
  direccion                 String?   // Dirección de la propiedad vendida
  precioVenta               Int?      // Precio de venta en USD
  
  // Sistema de Puntas Argentino
  // UNA PUNTA: 3% (solo vendedor o solo comprador)
  // DOS PUNTAS: 6% (ambos clientes)
  tipoPunta                 String    @default("UNA") // UNA | DOS
  
  // Comisiones calculadas automáticamente
  porcentajeComision        Float?    // 3% o 6% según puntas
  comisionBruta             Float?    // Total comisión de la inmobiliaria
  porcentajeAgente          Float?    // % que recibe el agente (viene de config inmobiliaria)
  comisionAgente            Float?    // Lo que recibe el agente
  
  // Estado
  estado                    String    @default("PENDIENTE") // PENDIENTE | COBRADA | CANCELADA
  
  // Cronograma
  fechaOperacion            DateTime  @default(now())
  fechaCobro                DateTime?
  observaciones             String?
  
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  
  @@index([nro])
  @@index([usuarioId])
  @@index([inmobiliariaId])
  @@index([estado])
}

// RESERVA Y DOCUMENTACION
model ReservaDocumento {
  id                    String    @id @default(cuid())
  
  nro                   Int?      @unique
  reservaTexto          String?
  boletoCompraVentaTexto String?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

// CONFIGURACION: Rutas y datos de importación
model ConfigImport {
  id                String    @id @default(cuid())
  
  clave             String    @unique // nombre de la configuración
  valor             String    // ruta o valor
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ENVIO DE PROPIEDAD: Registro de links enviados a clientes
model EnvioPropiedad {
  id                String    @id @default(cuid())
  
  clienteId         String
  cliente           Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  propiedadId       String?
  propiedad         Propiedad? @relation(fields: [propiedadId], references: [id], onDelete: SetNull)
  
  // Si no es una propiedad del sistema, guardar URL externa
  urlExterna        String?   // Link externo (MLS, Argenprop, etc)
  tituloExterno     String?   // Descripción del link externo
  
  // Detalles del envío
  canal             String    @default("WHATSAPP") // WHATSAPP | EMAIL | OTRO
  mensaje           String?   // Mensaje enviado (opcional)
  respuesta         String?   // INTERESADO | NO_INTERESADO | SIN_RESPUESTA | VISITA_PROGRAMADA
  
  fechaEnvio        DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([clienteId])
  @@index([propiedadId])
  @@index([fechaEnvio])
}

// COMUNICACION: Log de conversaciones WhatsApp/Email
model Comunicacion {
  id                String    @id @default(cuid())
  
  clienteId         String
  cliente           Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  // Tipo de comunicación
  tipo              String    @default("WHATSAPP") // WHATSAPP | LLAMADA | EMAIL | VISITA | OTRO
  direccion         String    @default("SALIENTE") // SALIENTE | ENTRANTE
  
  // Contenido
  resumen           String    // Resumen de la conversación
  detalle           String?   // Detalles adicionales
  
  // Resultado
  resultado         String?   // CONTACTADO | NO_CONTESTO | OCUPADO | CITA_AGENDADA | etc
  
  // Seguimiento
  requiereSeguimiento Boolean @default(false)
  fechaSeguimiento  DateTime?
  
  fecha             DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([clienteId])
  @@index([fecha])
  @@index([tipo])
}
